---
title: "Models"
author: "Thea Rolskov Sloth"
date: "15/10/2019"
output: html_document
---

#Getting packages
```{r loading packages, include = FALSE}
library(pacman)
p_load(brms, tidyverse, tidybayes, ggplot2, LaplacesDemon, rethinking, tidyr, reshape2, tibble, plotly, jpeg, tm, ggrepel, utils, boot, Hmisc, scales, gridExtra)
```

#Setting directory
```{r}
setwd("~/gender_bias_in_decision_making/Gender_bias_study_2")
```

#Loading data
```{r}
data_db <- read.csv("disagree_sensitivity_GBDM_long_format.csv")[, 2:44]
data_db_all <- read.csv("data_long_format_GBDM.csv")
```


#DECISION BIAS


###Same analysis as study 1 (excluding skill difference and confidence difference)

#Model 1
```{r model excluding skill dif}

#Defining priors
prior_db1 <- c(
  prior(normal(0,.2),class="b"),
  prior(normal(0,.1),class="sd")
)

#prior predictive check
model_db1_prior <- brm(leader_behavior ~ 0 + Leader_gender:Follower_gender + (0 + skill_dif_roll_c:Follower_gender | SubjectID), 
                       prior = prior_db1, 
                       data = data_db, 
                       sample_prior = "only",
                       iter = 4000, 
                       family = "bernoulli", 
                       chains = 2, 
                       cores = 2)

pp_check(model_db1_prior, nsamples = 100)


#Model 1; excluding skill difference and confidence difference
model_db1 <- brm(
  leader_behavior ~ 0 + Leader_gender : Follower_gender + ( 0 + skill_dif_roll_c : Follower_gender | SubjectID),
  data = data_db,
  prior = prior_db1,
  sample_prior=T,
  family = "bernoulli", #As we had a binary outcome, we set this to "bernoulli"
  seed = 123, # Adding a seed makes results reproducible.
  chains=4,
  cores=4
  #control = list(adapt_delta = 0.9) 
) 

#Model summary and plots
summary(model_db1)
plot(model_db1)
marginal_effects(model_db1)
```



##Alternative models

#Model 2: Full model (including skill difference and confidence difference)
```{r full model, 2}
#Defining priors 
prior_db2 <- c( 
  prior(normal(0,.2),class="b"),
  prior(normal(0,.1),class="sd")
)

#prior predictive check
model_db2_prior <- brm(leader_behavior ~ 0 + conf_dif_c*skill_dif_roll_c*Leader_gender:Follower_gender + (0 + skill_dif_roll_c:Follower_gender | SubjectID), 
                       prior = prior_db2, 
                       data = data_db, 
                       sample_prior = "only",
                       iter = 4000, 
                       family = "bernoulli", 
                       chains = 2, 
                       cores = 2)

pp_check(model_db2_prior, nsamples = 100)

#Model 2; including skill difference and confidence difference
model_db2 <- brm(leader_behavior ~ 0 + conf_dif_c*skill_dif_roll_c*Leader_gender:Follower_gender + (0 + skill_dif_roll_c:Follower_gender | SubjectID),
  data = data_db,
  prior = prior_db2,
  sample_prior=T,
  family = "bernoulli", #As we had a binary outcome, we set this to "bernoulli"
  seed = 123, # Adding a seed makes results reproducible.
  chains=4,
  cores=4
  #control = list(adapt_delta = 0.9) 
) 

#Model summary and plots
summary(model_db2)
plot(model_db2)
marginal_effects(model_db2)

```



##Investigating confidence variable
#Model 3
```{r}
#add column with absolute response
data_db_all$Response_abs <- abs(data_db_all$Response)

get_prior(Response_abs ~ Gender*Partner_gender + (1 | SubjectID), family = "gaussian",
                       data = data_db_all)
#Defining priors 
prior_db5 <- c( 
  prior(normal(2,1),class="Intercept"),
  prior(normal(0,.5),class="b"),
   prior(normal(0, .1),class="sd")
)


#prior predictive check
model_db5_prior <- brm(Response_abs ~ Gender*Partner_gender+ (1 | SubjectID), 
                       prior = prior_db5, 
                       data = data_db_all, 
                       sample_prior = "only",
                       iter = 4000, 
                       family = "gaussian", 
                       seed = 123,
                       chains = 2, 
                       cores = 2)

pp_check(model_db5_prior, nsamples = 100)

#Model
model_db5 <- brm(Response_abs ~ Gender*Partner_gender + (1 | SubjectID),
  data = data_db_all,
  prior = prior_db5,
  sample_prior=T,
  family = "gaussian", #As we had a binary outcome, we set this to "bernoulli"
  seed = 123, # Adding a seed makes results reproducible.
  chains=6,
  cores=4,
  control = list(adapt_delta = 0.9999) 
) 

#Model summary and plots
summary(model_db5)
plot(model_db5)
marginal_effects(model_db5)


```



##Investigating skill difference in relation to gender

#Model 1.1
```{r is men better than women regression, include = FALSE}

#Defining priors
prior_db6 <- c(
  prior(normal(0, 0.2),class="Intercept"),
  prior(normal(0,0.1),class="b"),
  prior(normal(0,0.2), class= "sd")
)


#prior predictive check
model_db6_prior <- brm(response_dummy ~ diff*Gender + (1+diff|SubjectID), 
                       prior = prior_db6, 
                       data = data_db_all, 
                       sample_prior = "only",
                       iter = 4000, 
                       family = "bernoulli", 
                       chains = 2,
                       control= list(adapt_delta = 0.99),
                       seed = 123,
                       cores = 2)

pp_check(model_db6_prior, nsamples = 100)

# Model answer predicted by gender and difficulty
model_db6 <- brm(
  response_dummy ~ diff*Gender + (1+diff|SubjectID), 
  data = data_db_all,
  prior = prior_db6,
  family = "bernoulli",
  sample_prior=T,
  seed = 123, # Adding a seed makes results reproducible.
  cores=4,
  chains=4
) 

#Model summary and plots
summary(model_db6)
plot(model_db6)
marginal_effects(model_db6)

```

##WAIC
```{r waic}
waic <- waic(model_db1, model_db2)

waic

```



## Hypothesis testing

##H1.1.1 Females perform worse than males do in the task

```{r}
#model db6 with star
hypothesis(model_db6, "diff < (diff+diff:GenderMale)")

```

##H3.1 Males generally express higher confidence than females

```{r}
#model db5
hypothesis(model_db5, "((Intercept + (Intercept + Partner_genderMale)) / 2) < (((Intercept + GenderMale) + (Intercept + GenderMale:Partner_genderMale))/2)")
```


##H3.2 Females and males are equally affected ny their partner's gender in terms of how they express their own confidence

```{r}
#model db5 
hypothesis(model_db5, "Partner_genderMale = (GenderMale + GenderMale:Partner_genderMale)")

#testing an alternative hypothesis with direction: 
hypothesis(model_db5, "(Intercept - (Intercept + Partner_genderMale)) > ((Intercept + GenderMale) -  (Intercept + GenderMale:Partner_genderMale))")


```


###Hypothesis testing with model 1

H1: there is a leader effect: male leaders tend to surrender less than female leaders
```{r H1: there is a leader effect: male leaders tend to surrender less than female leaders}
#H1: In general male leader tend to surrender less than female leaders

hypothesis(model_db1, "(Leader_genderMale:Follower_genderMale + Leader_genderMale:Follower_genderFemale)/2 < (Leader_genderFemale:Follower_genderMale + Leader_genderFemale:Follower_genderMale)/2")

```

H2: there is a follower effect: leaders tend to surrender more to men than to women
```{r H2: there is a follower effect: leaders tend to surrender more to men than to women }

# H2: There is a follower effect: leaders tend to surrender more to men than to women
hypothesis(model_db1, "(Leader_genderMale:Follower_genderMale + Leader_genderFemale:Follower_genderMale)/2 > (Leader_genderMale:Follower_genderFemale + Leader_genderFemale:Follower_genderFemale)/2")


```

H3: There is an interaction: Females are more discriminative as to their followers gender than males are
```{r H3: there is an interaction, females are more discriminative as to their followers gender than males are }

hypothesis(model_db1, "(Leader_genderMale:Follower_genderMale - Leader_genderMale:Follower_genderFemale) < (Leader_genderFemale:Follower_genderMale - Leader_genderFemale:Follower_genderFemale)")


```


###Hypothesis testing with model 2

```{r}

#H1.3 In general male leader tend to surrender less than female leaders

hypothesis(model_db2, "(Leader_genderMale:Follower_genderMale + Leader_genderMale:Follower_genderFemale)/2 < (Leader_genderFemale:Follower_genderMale + Leader_genderFemale:Follower_genderMale)/2")

#H1.4 There is a follower effect: leaders tend to surrender more to men than to women

hypothesis(model_db2, "(Leader_genderMale:Follower_genderMale + Leader_genderFemale:Follower_genderMale)/2 > (Leader_genderMale:Follower_genderFemale + Leader_genderFemale:Follower_genderFemale)/2")

#H3: There is an interaction: males are more discriminative as to their followers gender than females are

hypothesis(model_db2, "(Leader_genderMale:Follower_genderMale - Leader_genderMale:Follower_genderFemale) < (Leader_genderFemale:Follower_genderMale - Leader_genderFemale:Follower_genderFemale)")

```



#Plotting

##Model 1


```{r}
nd_db1 <- expand.grid(tibble(
         Follower_gender=factor(0:1) %>% rep(., times = 6),
         Leader_gender = factor(0:1) %>% rep(., times = 6),
         skill_dif_roll_c = 0,
         SubjectID = NA))

nd_db1$Follower_gender <- ifelse(nd_db1$Follower_gender == 0, "Male", "Female")

nd_db1$Leader_gender <- ifelse(nd_db1$Leader_gender == 0, "Male", "Female")


pred_db1 <-
  predict(model_db1, newdata = nd_db1) %>%
  as_tibble() %>%
  bind_cols(nd_db1)

```


###H1.1.1: In general, male leaders tend to surrender less than female leaders.

```{r}
#create the plot
H1.1.1 <- ggplot(data_db, aes(x = Leader_gender, y = leader_behavior, fill = Leader_gender)) +
  labs(x = "Leader gender", y = "Predicted propensity to surrender", title = "H1.1.1") +
  geom_boxplot(aes(x = Leader_gender, Estimate) , data = pred_db1, width = 0.5) + 
  theme(legend.position = "none", panel.grid.minor = element_blank()) + 
  geom_violin(aes(x = Leader_gender, y = Estimate), data = pred_db1, trim = FALSE, width =1, alpha = 0.1) + 
  scale_y_continuous(breaks = sort(c(seq(min(pred_db1$Estimate), max(pred_db1$Estimate), length.out=5), 0.5))) + 
  geom_hline(yintercept= 0.5, color = "black", linetype = "dashed", alpha = 0.8) + 
  scale_fill_manual(values=c("orange", "blue")) +
  theme(plot.title = element_text(hjust = 0.5))+ 
  theme(text = element_text(size=20))


H1.1.1

```

###H1.1.2: Leaders tend to surrender more to male followers than to female followers

```{r}
H1.1.2 <- ggplot(data_db, aes(x = Follower_gender, y = leader_behavior, fill = Follower_gender)) +
  labs(x = "Follower gender", y = "Predicted propensity to surrender", title = "H1.1.2") +
  geom_boxplot(aes(x = Follower_gender, Estimate) , data = pred_db1, width = 0.5) + 
  theme(legend.position = "none", panel.grid.minor = element_blank()) + 
  geom_violin(aes(x = Follower_gender, y = Estimate), data = pred_db1, trim = FALSE, width =1, alpha = 0.1) + 
  scale_y_continuous(breaks = sort(c(seq(min(pred_db1$Estimate), max(pred_db1$Estimate), length.out=5), 0.5))) + 
  geom_hline(yintercept= 0.5, color = "black", linetype = "dashed", alpha = 0.8) + 
  scale_fill_manual(values=c("orange", "blue")) +
  theme(plot.title = element_text(hjust = 0.5))+ 
  theme(text = element_text(size=20))

H1.1.2

```


###H1.1.3: Females are more discriminative towards their follower’s gender than males are, i.e. for female leaders, the gender of the follower makes a larger difference to their decision than it does for male leaders.

```{r}
H1.1.3 <- ggplot(pred_db1, aes(x = Leader_gender, y = Estimate, fill = Follower_gender)) + 
  geom_violin(aes(x = Leader_gender, y = Estimate), data = pred_db1, width = 0.7, alpha = 0.6) + 
  geom_hline(yintercept= 0.5, color = "black", linetype = "dashed", alpha = 0.8) + 
  scale_y_continuous(breaks = sort(c(seq(min(pred_db1$Estimate), max(pred_db1$Estimate), length.out=5), 0.5))) + 
  theme(panel.grid.minor = element_blank()) + 
  labs(x = "Leader gender", y = "Predicted propensity to surrender", title = "Hypothesis 1.1.1, 1.1.2 and 1.1.3 for model 1.1") + 
  stat_summary(fun.data=mean_sdl, geom="pointrange", color="black", position = position_dodge(width = 0.7), alpha = 0.8) +
  labs(fill = "Follower gender") + 
  scale_fill_manual(values=c("orange", "blue")) +
  theme(plot.title = element_text(hjust = 0.5)) + 
  scale_y_continuous(labels = percent_format(accuracy = 2)) + 
  theme(text = element_text(size=20))


H1.1.3

```


##Full model

model_db2 <- brm(leader_behavior ~ 1 + Follower_gender + conf_dif_c*skill_dif_roll_c*Leader_gender:Follower_gender + (1 + Follower_gender + skill_dif_roll_c:Follower_gender | SubjectID)



###Equal skill and confidence difference

```{r with equal skill dif and conf dif }
nd_db2.1 <- expand.grid(tibble(
         Follower_gender=factor(0:1) %>% rep(., times = 3),
         Leader_gender = factor(0:1) %>% rep(., times = 3),
         conf_dif_c = c(0) %>% rep(., times = 6),
         skill_dif_roll_c = c(0) %>% rep(., times = 6),
         SubjectID = NA))


nd_db2.1$Follower_gender <- ifelse(nd_db2.1$Follower_gender == 0, "Male", "Female")

nd_db2.1$Leader_gender <- ifelse(nd_db2.1$Leader_gender == 0, "Male", "Female")


pred_db2.1 <-
  predict(model_db2, newdata = nd_db2.1) %>%
  as_tibble() %>%
  bind_cols(nd_db2.1)
```


####Test of H1, H2 and H3 on the full model

```{r}

H2.1.1 <- ggplot(data_db, aes(x = Leader_gender, y = leader_behavior, fill = Leader_gender)) +
  labs(x = "Leader gender", y = "Predicted propensity to surrender", title = "H2.1.1") +
  geom_boxplot(aes(x = Leader_gender, Estimate) , data = pred_db2.1, width = 0.5) + 
  theme(legend.position = "none", panel.grid.minor = element_blank()) + 
  geom_violin(aes(x = Leader_gender, y = Estimate), data = pred_db2.1, trim = FALSE, width =1, alpha = 0.1) + 
  scale_y_continuous(breaks = sort(c(seq(min(pred_db2.1$Estimate), max(pred_db2.1$Estimate), length.out=5), 0.5))) + 
  geom_hline(yintercept= 0.5, color = "black", linetype = "dashed", alpha = 0.8) + 
  scale_fill_manual(values=c("orange", "blue"))  + 
  theme(text = element_text(size=20))

H2.1.1



H2.1.2 <- ggplot(data_db, aes(x = Follower_gender, y = leader_behavior, fill = Follower_gender)) +
  labs(x = "Follower gender", y = "Predicted propensity to surrender", title = "H2.1.2") +
  geom_boxplot(aes(x = Follower_gender, Estimate) , data = pred_db2.1, width = 0.5) + 
  theme(legend.position = "none", panel.grid.minor = element_blank()) + 
  geom_violin(aes(x = Follower_gender, y = Estimate), data = pred_db2.1, trim = FALSE, width =1, alpha = 0.1) + 
  scale_y_continuous(breaks = sort(c(seq(min(pred_db2.1$Estimate), max(pred_db2.1$Estimate), length.out=5), 0.5))) + 
  geom_hline(yintercept= 0.5, color = "black", linetype = "dashed", alpha = 0.8) + 
  scale_fill_manual(values=c("orange", "blue"))  + 
  theme(text = element_text(size=20))

H2.1.2

H2.1.3 <- ggplot(pred_db2.1, aes(x = Leader_gender, y = Estimate, fill = Follower_gender)) + 
  geom_violin(aes(x = Leader_gender, y = Estimate), data = pred_db2.1, width = 0.7, alpha = 0.6) + 
  scale_y_continuous(breaks = sort(c(seq(min(pred_db2.1$Estimate), max(pred_db2.1$Estimate), length.out=5), 0.5))) + 
  theme(panel.grid.minor = element_blank()) + 
  labs(x = "Leader gender", y = "Predicted propensity to surrender", title = "Hypothesis 1.1.1, 1.1.2 and 1.1.3 for model 1.2 ") + 
  stat_summary(fun.data=mean_sdl, geom="pointrange", color="black", position = position_dodge(width = 0.7), alpha = 0.8) +
  labs(fill = "Follower gender") + 
  scale_fill_manual(values=c("orange", "blue")) +
  theme(plot.title = element_text(hjust = 0.5))  + 
  theme(text = element_text(size=20)) +
  scale_y_continuous(labels = percent_format(accuracy = 2)) 

H2.1.3
```


###Different confidence 

```{r with different confidence}
nd_db2 <- expand.grid(tibble(
         Follower_gender=factor(0:1) %>% rep(., times = 5),
         Leader_gender = factor(0:1) %>% rep(., times = 5),
         conf_dif_c = c((4/1-1), (4/2-1),(4/3-1), (3/1-1), (3/2-1),0, (3/4-1), (2/3-1), (2/4-1), (1/3-1)) %>% rep(., times = 1),
         skill_dif_roll_c = 0,
         SubjectID = NA))


nd_db2$Follower_gender <- ifelse(nd_db2$Follower_gender == 0, "Male", "Female")

nd_db2$Leader_gender <- ifelse(nd_db2$Leader_gender == 0, "Male", "Female")


pred_db2 <-
  predict(model_db2, newdata = nd_db2) %>%
  as_tibble() %>%
  bind_cols(nd_db2)

pred_db2_save <- pred_db2
```

####plot with different confidence
```{r}
#turn into factor
pred_db2$conf_dif_c <- as.character(pred_db2$conf_dif_c)
pred_db2$conf_dif_c <- as.factor(pred_db2$conf_dif_c)

#change order of factor levels
pred_db2$conf_dif_c <- factor(pred_db2$conf_dif_c,levels(pred_db2$conf_dif_c)[c(4,3,2,1,5,6,7,8,9,10)])

#change names of factor levels
levels(pred_db2$conf_dif_c) <- c("-0.67","-0.5","-0.33","-0.25","0","0.33","0.5", "1", "2", "3")

pred_db2$leader_follower <- NA
pred_db2$leader_follower[pred_db2$Leader_gender == "Female"  & pred_db2$Follower_gender == "Female"] <- "FF"
pred_db2$leader_follower[pred_db2$Leader_gender == "Female"  & pred_db2$Follower_gender == "Male"] <- "FM"
pred_db2$leader_follower[pred_db2$Leader_gender == "Male"  & pred_db2$Follower_gender == "Female"] <- "MF"
pred_db2$leader_follower[pred_db2$Leader_gender == "Male"  & pred_db2$Follower_gender == "Male"] <- "MM"


plot_conf <- ggplot(data=pred_db2, aes(x=conf_dif_c, y=Estimate, group=leader_follower))+
    geom_line(size=1, aes(color=leader_follower))+
    ylab("Predicted propensity to surrender")+
    xlab("Difference in confidence between leader and follower gender")+
    ggtitle("Difference in confidence and gender as predictors of propensity to surrender")+
    theme_bw()+
    scale_fill_manual(values=c("orange", "blue", "orange", "blue")) +
    theme(text = element_text(size=12),
        legend.text = element_text(size=12),
        legend.direction = "horizontal",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position="top")+ 
  theme(text = element_text(size=20))+labs(colour="Leader Gender, Follower Gender") +
  scale_y_continuous(labels = percent_format(accuracy = 2)) 


plot_conf
```


###Different skill


```{r}
nd_db2.2 <- expand.grid(tibble(
         Follower_gender=factor(0:1) %>% rep(., times = 3),
         Leader_gender = factor(0:1) %>% rep(., times = 3),
         conf_dif_c = 0,
         skill_dif_roll_c = seq(quantile(data_db$skill_dif_roll_c,probs=c(.025)), quantile(data_db$skill_dif_roll_c,probs=c(.975)), 0.1),
         SubjectID = NA))


nd_db2.2$Follower_gender <- ifelse(nd_db2.2$Follower_gender == 0, "Male", "Female")

nd_db2.2$Leader_gender <- ifelse(nd_db2.2$Leader_gender == 0, "Male", "Female")


pred_db2.2 <-
  predict(model_db2, newdata = nd_db2.2) %>%
  as_tibble() %>%
  bind_cols(nd_db2.2)


pred_db2.2_save <- pred_db2.2


```

####plot with different skill

```{r}
pred_db2.2$leader_follower <- NA
pred_db2.2$leader_follower[pred_db2.2$Leader_gender == "Female"  & pred_db2.2$Follower_gender == "Female"] <- "FF"
pred_db2.2$leader_follower[pred_db2.2$Leader_gender == "Female"  & pred_db2.2$Follower_gender == "Male"] <- "FM"
pred_db2.2$leader_follower[pred_db2.2$Leader_gender == "Male"  & pred_db2.2$Follower_gender == "Female"] <- "MF"
pred_db2.2$leader_follower[pred_db2.2$Leader_gender == "Male"  & pred_db2.2$Follower_gender == "Male"] <- "MM"


plot_skill <- ggplot(data=pred_db2.2, aes(x=skill_dif_roll_c, y=Estimate, group=leader_follower))+
    geom_point(size=1, aes(color=leader_follower))+
    ylab("Predicted propensity to surrender")+
    xlab("Difference in confidence between leader and follower gender")+
    ggtitle("Difference in confidence and gender as predictors of propensity to surrender")+
    theme_bw()+
    theme(text = element_text(size=12),
        legend.text = element_text(size=12),
        legend.direction = "horizontal",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position="top")

plot_skill
```


##Expressing confidence

Response absolute ~ Gender*Partner’s gender + (1 | Subject)

```{r}
nd_db3 <- expand.grid(tibble(
         Gender=factor(0:1) %>% rep(., times = 2),
         Partner_gender = factor(0:1) %>% rep(., times = 2),
         Response_abs = c(1,2,3,4),
         SubjectID = NA))


nd_db3$Gender <- ifelse(nd_db3$Gender == 0, "Male", "Female")

nd_db3$Partner_gender <- ifelse(nd_db3$Partner_gender == 0, "Male", "Female")


pred_db3 <-
  predict(model_db5, newdata = nd_db3) %>%
  as_tibble() %>%
  bind_cols(nd_db3)
```

```{r}
scaleFUN <- function(x) sprintf("%.2f", x)
H3 <- ggplot(pred_db3, aes(x = Gender, y = Estimate, fill = Partner_gender)) + 
  geom_violin(aes(x = Gender, y = Estimate), data = pred_db3, width = 0.7, alpha = 0.6) + 
  scale_y_continuous(breaks = sort(c(seq(min(pred_db3$Estimate), max(pred_db3$Estimate), length.out=6), 0.5))) + 
  theme(panel.grid.minor = element_blank()) + 
  labs(x = "Gender", y = "Mean expressed confidence", title = "Hypothesis 1.5.1 and 1.5.2") + 
  stat_summary(fun.data=mean_sdl, geom="pointrange", color="black", position = position_dodge(width = 0.7), alpha = 0.8) +
  labs(fill = "Partner gender") + 
  scale_fill_manual(values=c("orange", "blue")) + 
  theme(plot.title = element_text(hjust = 0.5)) + 
  theme(text = element_text(size=20)) +
  scale_y_continuous(labels=scaleFUN)


H3
```


Model_db1
Leader behavior ~ 0 + Leader gender:Follower gender + (0 + skill difference : Follower gender | Subject)


```{r}
nd_db1 <- expand.grid(tibble(
         Follower_gender=factor(0:2) %>% rep(., times = 10),
         Leader_gender = factor(0:2) %>% rep(., times = 10),
         SubjectID = NA))



nd_db1$Follower_gender <- ifelse(nd_db1$Follower_gender == 0, "Male", "Female")

nd_db1$Leader_gender <- ifelse(nd_db1$Leader_gender == 0, "Male", "Female")


pred_db1 <-
  predict(model_db1, newdata = nd_db1) %>%
  as_tibble() %>%
  bind_cols(nd_db1)

```


#H1.1.1: In general, male leaders tend to surrender less than female leaders.

```{r}
#create the plot
H1.1.1 <- ggplot(data_db, aes(x = Leader_gender, y = leader_behavior, fill = Leader_gender)) +
  labs(x = "Leader gender", y = "Predicted propensity to surrender", title = "H1.1.1") +
  geom_boxplot(aes(x = Leader_gender, Estimate) , data = pred_db1, width = 0.5) + 
  theme(legend.position = "none", panel.grid.minor = element_blank()) + 
  geom_violin(aes(x = Leader_gender, y = Estimate), data = pred_db1, trim = FALSE, width =1, alpha = 0.1) + 
  scale_y_continuous(breaks = sort(c(seq(min(pred_db1$Estimate), max(pred_db1$Estimate), length.out=5), 0.5))) + 
  geom_hline(yintercept= 0.5, color = "black", linetype = "dashed", alpha = 0.8) + 
  scale_fill_manual(values=c("orange", "blue"))

H1.1.1

```

#H1.1.2: Leaders tend to surrender more to male followers than to female followers

```{r}
H1.1.2 <- ggplot(data_db, aes(x = Follower_gender, y = leader_behavior, fill = Follower_gender)) +
  labs(x = "Follower gender", y = "Predicted propensity to surrender", title = "H1.1.2") +
  geom_boxplot(aes(x = Follower_gender, Estimate) , data = pred_db1, width = 0.5) + 
  theme(legend.position = "none", panel.grid.minor = element_blank()) + 
  geom_violin(aes(x = Follower_gender, y = Estimate), data = pred_db1, trim = FALSE, width =1, alpha = 0.1) + 
  scale_y_continuous(breaks = sort(c(seq(min(pred_db1$Estimate), max(pred_db1$Estimate), length.out=5), 0.5))) + 
  geom_hline(yintercept= 0.5, color = "black", linetype = "dashed", alpha = 0.8) + 
  scale_fill_manual(values=c("orange", "blue"))

H1.1.2

```


#H1.1.3: Females are more discriminative towards their follower’s gender than males are, i.e. for female leaders, the gender of the follower makes a larger difference to their decision than it does for male leaders.

```{r}
H1.1.3 <- ggplot(pred_db1, aes(x = Leader_gender, y = Estimate, fill = Follower_gender)) + 
  geom_violin(aes(x = Leader_gender, y = Estimate), data = pred_db1, width = 0.7, alpha = 0.8) + 
  geom_hline(yintercept= 0.5, color = "black", linetype = "dashed", alpha = 0.8) + 
  scale_y_continuous(breaks = sort(c(seq(min(pred_db1$Estimate), max(pred_db1$Estimate), length.out=5), 0.5))) + 
  theme(panel.grid.minor = element_blank()) + 
  labs(x = "Leader gender", y = "Predicted propensity to surrender", title = "H1.1.3") + 
  stat_summary(fun.data=mean_sdl, geom="pointrange", color="black", position = position_dodge(width = 0.7), alpha = 0.8) +
  labs(fill = "Follower gender") + 
  scale_fill_manual(values=c("orange", "blue"))

H1.1.3

```





##Look into confidence variable 

```{r}
conf_plot <- ggplot(data_db, aes(x=Leader_gender, y=conf_dif_c, fill = Follower_gender)) + geom_boxplot() + facet_wrap(~Leader_gender)
conf_plot


plot1 <- ggplot(data_db, aes(x=conf_dif_c, y = leader_behavior, fill = Leader_gender)) + geom_point() + facet_wrap(~Leader_gender)
plot1


```

```{r prepare predictions}
nd <- expand.grid(tibble(
         Follower_gender=factor(0:1) %>% rep(., times = 10),
         Leader_gender = factor(0:1) %>% rep(., times = 10),
         conf_dif = factor((4/1-1), (4/2-1),(4/3-1), 0, (3/1-1), (3/2-1), (3/4-1), (2/3-1), (2/4-1), (1/3-1), (1/4-1)) %>% rep(., times = 10),
         SubjectID = NA))

nd <- expand.grid(tibble(
         Follower_gender=seq(0:2) %>% rep(., times = 10),
         Leader_gender = factor(0:2) %>% rep(., times = 10),
         SubjectID = NA))



nd$Follower_gender <- ifelse(nd$Follower_gender == 0, "Male", "Female")

nd$Leader_gender <- ifelse(nd$Leader_gender == 0, "Male", "Female")


pred <-
  predict(model_db1, newdata = nd, re_formula = ~ (0 + Follower_gender | SubjectID)) %>%  # we can use the same nd data from last time
  as_tibble() %>%
  bind_cols(nd)
```


```{r H1 plot}
#create the plot
H1 <- ggplot(disagree_db_long, aes(x = Leader_gender, y = leader_behavior, fill = Leader_gender)) +
  labs(x = "Leader gender", y = "Predicted propensity to surrender", title = "Hypothesis 1") +
  geom_boxplot(aes(x = Leader_gender, Estimate) , data = pred, width = 0.5) + 
  theme(legend.position = "none", panel.grid.minor = element_blank()) + 
  geom_violin(aes(x = Leader_gender, y = Estimate), data = pred, trim = FALSE, width =1, alpha = 0.1) + 
  scale_y_continuous(breaks = sort(c(seq(min(pred$Estimate), max(pred$Estimate), length.out=5), 0.5))) + 
  geom_hline(yintercept= 0.5, color = "black", linetype = "dashed", alpha = 0.8) + 
  scale_fill_manual(values=c("palegreen3", "gold2"))
H1
```


```{r H2: plotting}

#create the plot
H2 <- ggplot(disagree_db_long, aes(x = Follower_gender, y = leader_behavior, fill = Follower_gender)) +
  labs(x = "Follower gender", y = "Predicted propensity to surrender", title = "Hypothesis 2") +
  geom_boxplot(aes(x = Follower_gender, Estimate) , data = pred, width = 0.5) + 
  theme(legend.position = "none", panel.grid.minor = element_blank()) + 
  geom_violin(aes(x = Follower_gender, y = Estimate), data = pred, trim = FALSE, width =1, alpha = 0.1) + 
  scale_y_continuous(breaks = sort(c(seq(min(pred$Estimate), max(pred$Estimate), length.out=5), 0.5))) + 
  geom_hline(yintercept= 0.5, color = "black", linetype = "dashed", alpha = 0.8) + 
  scale_fill_manual(values=c("palegreen3", "gold2"))

H2
```

H3: plotting
```{r H3.1 plotting}
marginal_effects(model_db1)

#create the plot
H3.1 <- ggplot(disagree_db_long, aes(x = Leader_gender, y = leader_behavior, fill = Follower_gender)) +
  labs(x = "Leader gender", y = "Predicted propensity to surrender", title = "Hypothesis 3 - Boxplot") +
  geom_boxplot(aes(x = Leader_gender, Estimate, fill = Follower_gender) , data = pred, width = 0.5, alpha = 0.8) + 
  labs(fill = "Follower gender") +
  theme(panel.grid.minor = element_blank()) +
  scale_y_continuous(breaks = sort(c(seq(min(pred$Estimate), max(pred$Estimate), length.out=5)))) +
  scale_fill_manual(values=c("palegreen3", "gold2"))

H3.1

```

```{r H3.2 Plotting}
H3.2 <- ggplot(pred, aes(x = Leader_gender, y = Estimate, fill = Follower_gender)) + 
  geom_violin(aes(x = Leader_gender, y = Estimate), data = pred, width = 0.7, alpha = 0.8) + 
  geom_hline(yintercept= 0.5, color = "black", linetype = "dashed", alpha = 0.8) + 
  scale_y_continuous(breaks = sort(c(seq(min(pred$Estimate), max(pred$Estimate), length.out=5), 0.5))) + 
  theme(panel.grid.minor = element_blank()) + 
  labs(x = "Leader gender", y = "Predicted propensity to surrender", title = "Hypothesis 3") + 
  stat_summary(fun.data=mean_sdl, geom="pointrange", color="black", position = position_dodge(width = 0.7), alpha = 0.8) +
  labs(fill = "Follower gender") + 
  scale_fill_manual(values=c("palegreen3", "gold2"))
```
 
 
##Model looking at confidence in relation to skill

```{r}

#create response abs
data_db_long$Response_abs <- abs(data_db_long$Response)
data_db_long$Response_abs_z <- scale(data_db_long$Response)


#remove the first 10 trials

data_db_long <- data_db_long[11:12352,]

#Defining priors 
prior_db_conf_skill <- c( 
  prior(normal(0,0.1),class="Intercept"),
  prior(normal(0,.2),class="b"),
  prior(normal(0,.1),class="sd")
)

#prior predictive check
model_db_conf_skill_prior <- brm(Sensitivity_roll ~ 1 + Response_abs_z * Gender + (1 | SubjectID), 
                       prior = prior_db_conf_skill, 
                       data = data_db_long, 
                       sample_prior = "only",
                       iter = 4000, 
                       family = "gaussian", 
                       chains = 2, 
                       cores = 2)

pp_check(model_db_conf_skill_prior, nsamples = 100)


model_db_conf_skill <- brm(Sensitivity_roll ~ 1 + Response_abs_z * Gender + (1 | SubjectID),
  data = data_db_long,
  prior = prior_db_conf_skill,
  sample_prior=T,
  family = "gaussian", #As we had a binary outcome, we set this to "bernoulli"
  seed = 123, # Adding a seed makes results reproducible.
  chains=4,
  cores=4,
  control = list(adapt_delta = 0.9) 
) 

```

```{r extra shit from thea to all of us }

thea <- data_db_all

thea <- filter(data_db, Follower_gender != Leader_gender)




```

