---
title: "Preprocessing"
author: "MM"
date: "2/5/2019"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Loading packages
```{r loading packages, include = FALSE}
library(brms);library(tidyverse); library(tidybayes); library(ggplot2); library(LaplacesDemon); library(tidyr); library(reshape2);library(pacman); library(tibble);library(tidyr);

```

#Loading data 
```{r}
data <- read.csv("anonymised_data.csv")
```

#Preparing data
##Adding difficulty variable og dummy coding
```{r making variables for sensitivty, include = FALSE}
#Making unique subjects
data$unique_ID_right <- paste(data$GroupNumber, data$SubjectID_right, sep = "_")
data$unique_ID_left <- paste(data$GroupNumber, data$SubjectID_left, sep = "_")

#Making column, which expresses difficulty
data$dif_blue <- data$Prop_blue_image_2 - data$Prop_blue_image_1
data$dif_blue_abs <- abs(data$Prop_blue_image_2 - data$Prop_blue_image_1)

#Making a column, which expresses answer of participants, 0 = left picture, 1 = right picture
data$right_answer <- ifelse(data$Response_right > 0, 1, 0)
data$left_answer <- ifelse(data$Response_left > 0, 1, 0)

#Joining joint answer to one column
data$joint_answer <- data$Joint_right+ data$Joint_left

#Recoding joint answer to be 0 and 1's, 0 right, 1 left, NA = no leader
data$joint_answer[data$joint_answer == 0] <- NA #Replacing 0's with NA
data$joint_answer[data$joint_answer == -1] <- 0
```


##Adding variables: Agree, chosen leader and gender
```{r coding for leader/follower}

#create a column that sorts out all the agreed trials
data$chosen_leader <- ifelse(data$right_answer == data$left_answer, "Agree", 0) 

#Create variable, which determines the chosen leader
data$chosen_leader[data$chosen_leader == 0 & data$Joint_right == 0] <- "Left_lead"
data$chosen_leader[data$chosen_leader == 0 & data$Joint_left == 0] <- "Right_lead"

#create column that specifies the gender of the leader
data$Leader_gender <- 0
data$Leader_gender <- ifelse(data$chosen_leader == "Left_lead", as.character(data$Gender_left), as.character(data$Gender_right))
data$Leader_gender[data$chosen_leader == "Agree"] <- NA

#create column that specifies the gender of the follower
data$Follower_gender <- 0
data$Follower_gender <- ifelse(data$chosen_leader == "Left_lead", as.character(data$Gender_right), as.character(data$Gender_left))
data$Follower_gender[data$chosen_leader == "Agree"] <- NA

#Dummycoding leader gender and follower gender, male = 0, female = 1
data$Leader_gender[data$Leader_gender == "Male"] <- 0
data$Leader_gender[data$Leader_gender == "Female"] <- 1
data$Follower_gender[data$Follower_gender == "Male"] <- 0
data$Follower_gender[data$Follower_gender == "Female"] <- 1

```

##Adding variable: Leader behaviour
```{r Did the leader stick?}
#Creating column of 0's
data$leader_behaviour <- 0 

#Inserting cases were leader stick for right leader
data$leader_behaviour[data$chosen_leader == "Right_lead" & data$joint_answer == data$right_answer] <- "stick" 

#Inserting cases were leader surrender for right leader
data$leader_behaviour[data$chosen_leader == "Right_lead" & data$joint_answer != data$right_answer] <- "surrender" 

#Inserting cases were leader stick for left leader
data$leader_behaviour[data$chosen_leader == "Left_lead" & data$joint_answer == data$left_answer] <- "stick" 

#Inserting cases were leader surreder for left leader
data$leader_behaviour[data$chosen_leader == "Left_lead" & data$joint_answer != data$left_answer] <- "surrender" 

#Removing cases were they agree
data$leader_behaviour[data$chosen_leader == "Agree"] <- NA 

#dummycode leader behaviour , surrender = 1, stick = 0
data$leader_behaviour[data$leader_behaviour == "surrender"] <- 1

data$leader_behaviour[data$leader_behaviour == "stick"] <- 0

```

##Adding variable: Confidence
```{r}
#rename confidence
names(data)[names(data) == 'Response_left'] <- 'confidence_left'
names(data)[names(data) == 'Response_right'] <- 'confidence_right'

```


#Sensitivity scores, partial pooling
We need one column containing answer from both left and right in order to allow pooling between all participants

##Long format
```{r making long format, include = FALSE}
#Subsetting the left data
left <- subset(data, select = c(GroupNumber, unique_ID_left, dif_blue, left_answer, joint_answer, Correct_left, Correct_joint, dif_blue_abs))

#Changing names
names(left) <- c("GroupNumber", "unique", "dif_blue", "answer", "joint_answer", "Correct", "Correct_joint", "dif_blue_abs")

#Subsetting right data
right <- subset(data, select = c(GroupNumber, unique_ID_right, dif_blue, right_answer, joint_answer, Correct_left, Correct_joint, dif_blue_abs))

#Chainging names
names(right) <- c("GroupNumber", "unique", "dif_blue", "answer", "joint_answer", "Correct", "Correct_joint", "dif_blue_abs")

#Removing half the joint data to inform the model, there is only one. 
right$Correct_joint <- NA
right$joint_answer <- NA

#Joining the dataframes
ldata <- rbind(left, right)

#Setting NA in correct answers
ldata$Correct_joint[is.na(ldata$joint_answer)] <- NA

```

##Modelling sensitivity scores (using answer)
```{r creating model with partial pooling, individual}

#Getting priors
get_prior(answer ~ dif_blue + (1+ dif_blue|unique), family = "bernoulli", data = ldata)

#Defining priors
prior =  c(
  prior(normal(0,0.125), class = "b", coef = "dif_blue"),
  prior(normal(0,0.17), class = "Intercept"),
  prior(normal(0,0.125), class = "sd", coef = "dif_blue", group = "unique"),
  prior(normal(0,0.17), class = "sd", coef = "Intercept", group = "unique")
)

  
#Defining paths for plots
trans_path = file.path("~/gender_bias_in_decision_making/Gender_bias_study_1/plots/transition/trans_plot_sensitivity.jpeg")
pp_path = file.path("~/gender_bias_in_decision_making/Gender_bias_study_1/plots/pp_check/pp_plot_sensitivity.jpeg")

marginal_path = file.path("~/gender_bias_in_decision_making/Gender_bias_study_1/plots/marginal/marginal_plot_sensitivity.jpeg")


#Prior predictive check
prior_check <- brm( answer ~ dif_blue + (dif_blue|unique), prior = prior,
           data = ldata, sample_prior = "only",iter = 4000, family = "bernoulli")


#Making the model
m_sensitivity <- brm(
  answer ~ dif_blue + (1+dif_blue|unique),
  data = ldata,
  prior = prior,
  family = "bernoulli", #As we had a binary outcome, we set this to "bernoulli"
  seed = 123 # Adding a seed makes results reproducible.
) 


#Marginal effects plot: Plotted and saved
jpeg(file=marginal_path)
print(marginal_effects(m_sensitivity))
dev.off()
  
#transition plot: Plotted and saved
jpeg(file=trans_path)
print(plot(m_sensitivity))
dev.off()

#pp_check plot: Plotted and saved
jpeg(file=pp_path)
print(pp_check(prior_check, nsamples = 100))
dev.off()

```


##Saving estimates from sensitivity
```{r}
#Saving the estimates

#Saving random effect for individual 
ranef <- as.data.frame(ranef(m_sensitivity))[,1:2] #Intercept
ranef <- cbind(ranef, as.data.frame(ranef(m_sensitivity))[,5:6]) #Slope

#Adding fixed effects to random effect
fixef <- as.data.frame(fixef(m_sensitivity)) #Making data frame of fixed effects

sensitivity_scores <-data.frame(matrix(ncol = 0, nrow = 80))

sensitivity_scores$Slope_ranef_fixef_estimate <- ranef[, 3] + fixef[1, 2] #Adding fixef of slope to ranef of slope


#Adding rownames
sensitivity_scores <- cbind(Row.Names = rownames(ranef), as.data.frame(sensitivity_scores))

write.csv(sensitivity_scores, file = "sensitivity_scores.csv")
```

#Making a wide format 
```{r creating wide format, include = FALSE, this does not work}

#Creating two empty columns in data for sensitivity scores
data$sensitivity_right <- NA
data$sensitivity_left <- NA

#Looping through sensitivity scores and matching them to the right player
t = 1
for (i in sensitivity_scores$Row.Names) {
  print(i)
  for (p in data$unique_ID_right) {
    if(i == p){
      data$sensitivity_right[data$unique_ID_right == p] = sensitivity_scores$Slope_ranef_fixef_estimate[t]
    } 
  }
  t = t+1
}


#Looping through sensitivity scores and matching them to the left player
t = 1
for (i in sensitivity_scores$Row.Names) {
  print(i)
  for (p in data$unique_ID_left) {
    if(i == p){
      data$sensitivity_left[data$unique_ID_left == p] = sensitivity_scores$Slope_ranef_fixef_estimate[t]
    } 
  }
  t = t+1
}

```

#Adding variable: Skill difference
```{r calculate skill difference}

#Calculating skill difference
data$skill_dif <- 0 #Creating column of 0
data$skill_dif <- ifelse(data$chosen_leader == "Left_lead", data$sensitivity_left/data$sensitivity_right, data$sensitivity_right/data$sensitivity_left) #calculating skill difference as a ratio between leader and follower sensitivity

#Insert NAs in all agree trials
data$skill_dif[data$chosen_leader == "Agree"] <- NA 
```

#Making long format
##Subsetting left data
```{r}
#Subset to left data
data_left <- subset(data, select = c(GroupNumber, unique_ID_left, dif_blue, dif_blue_abs, chosen_leader, Leader_gender, Follower_gender, skill_dif, confidence_left, leader_behaviour, sensitivity_left, Gender_left, left_answer)) #take all data for left participant

data_left$skill_dif[data_left$chosen_leader != 'Left_lead'] <- NA #insert NAs for chosen leader if not left

data_left$leader_behaviour[data_left$chosen_leader != 'Left_lead'] <- NA #insert NAs for chosen leader if not left
data_left$Leader_gender[data_left$chosen_leader != 'Left_lead'] <- NA #insert NAs for chosen leader if not left
data_left$Follower_gender[data_left$chosen_leader != 'Left_lead'] <- NA #insert NAs for chosen leader if not left

```

##Subsetting right data
```{r}
#Subset right data
data_right <- subset(data, select = c(GroupNumber, unique_ID_right, dif_blue, dif_blue_abs, chosen_leader, Leader_gender, Follower_gender, skill_dif, confidence_right, leader_behaviour, sensitivity_right, Gender_right, right_answer)) #Subsetting right data

data_right$skill_dif[data_right$chosen_leader != 'Right_lead'] <- NA #insert NAs for chosen leader if not right

data_right$leader_behaviour[data_right$chosen_leader != 'Right_lead'] <- NA #insert NAs for chosen leader if not right

data_right$Leader_gender[data_right$chosen_leader != 'Right_lead'] <- NA #insert NAs for chosen leader if not right

data_right$Follower_gender[data_right$chosen_leader != 'Right_lead'] <- NA #insert NAs for chosen leader if not right

```

##Merging data frames
```{r make long format}
#Renaming the columns to match
names(data_left) <- c("GroupNumber", "Subject", "dif_blue", "dif_blue_abs", "chosen_leader", "Leader_gender", "Follower_gender", "skill_dif", "confidence", "leader_behaviour", "skill_level", "Gender", "answer")

names(data_right) <- c("GroupNumber", "Subject", "dif_blue", "dif_blue_abs", "chosen_leader", "Leader_gender", "Follower_gender", "skill_dif", "confidence", "leader_behaviour", "skill_level", "Gender", "answer")

#Rbinding left and right data
data_long <- rbind(data_left, data_right)

```


#Write CSV with sensitivity scores and clean data
```{r}
write.csv(data_long, file = "data_long_sensitivity.csv")
```


#Removing agree-trials
```{r}
#Removing all agree trials
data_disagree_long <- na.omit(data_long)

```

#Cleaning the long data
```{r}
#remove the groupnumber from subject name to account for within participant variation
data_disagree_long$Subject <- as.character(data_disagree_long$Subject)
data_disagree_long$Subject <- tolower(data_disagree_long$Subject)

data_disagree_long$Subject <- str_extract(data_disagree_long$Subject,"[a-z]+")

#scale the skill difference variable 
data_disagree_long$skill_dif <- scale(data_disagree_long$skill_dif)


```


#Write CSV with sensitivity scores and clean data, only disagree
```{r}
write.csv(data_disagree_long, file = "data_disagree_long_sensitivity.csv")
```

