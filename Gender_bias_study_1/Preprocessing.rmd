---
title: "DataCleaning"
author: "Signe Kløve Kjær"
date: "2/5/2019"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Loading packages
```{r loading packages, include = FALSE}
library(brms);library(tidyverse); library(tidybayes); library(ggplot2); library(LaplacesDemon); library(tidyr); library(reshape2);library(pacman); library(tibble);library(tidyr);

```


#Define path
```{r}
#Defining path
#data_path = ("C:/Users/KK/OneDrive - Aarhus Universitet/Dokumenter/MM, udgives/gender_bias_in_decision_making/Gender_bias_study_1/Data/") #Kiri

#Thea
#setwd("~/SocKultExam")
#data_path = ("Data/") 

#Signe
data_path = ("/Users/signeklovekjaer/gender_bias_in_decision_making/Gender_bias_study_1/Data/")
```


#Loading data and merging
```{r loading main data include = FALSE}
#Listing files in path
files <- list.files(path = data_path)

#Create empty data frame
data <- data.frame(matrix(ncol = 36, nrow = 0))

#Looping through data files and inserting in dataframe
for (i in files) {
  d <- read.delim(file = paste(data_path, i, sep = ""), sep = ",", header = TRUE)
  data = rbind(data,d)
}

```

```{r loading data with different amount of trials}
#Setting different path for extraordinary files
#kiri_path = ("~/SocKultExam/") #Thea
#kiri_path = ("C:/Users/KK/OneDrive - Aarhus Universitet/Dokumenter/MM, udgives/gender_bias_in_decision_making/Gender_bias_study_1/kiri/")#Kiri
kiri_path = ("/Users/signeklovekjaer/gender_bias_in_decision_making/Gender_bias_study_1/kiri/") #Signe

#Listing files in directory
kiri_files <- list.files(path = kiri_path, pattern = "*.csv") 

#Creating empty data frame
kiri_data <- data.frame(matrix(ncol = 35, nrow = 0))

#Looping through Kiri data 
for (i in kiri_files) {
  d <- read.delim(file = paste(kiri_path, i, sep = ""), sep = ",", header = TRUE, stringsAsFactors = FALSE)
  kiri_data = rbind(kiri_data, d)
}

```


```{r}
#Merge the two dataframes
kiri_data <- add_column(kiri_data, Computer = "Two screens", .after = 4)
data <- rbind(data, kiri_data)
```


#Data cleaning
```{r cleaning data, include = FALSE}
#Removing column of x
data <- subset(data, select = -c(X))

#Cleaning group numbers
data$GroupNumber[data$GroupNumber == "17_10_30"] <- 17
data$GroupNumber[data$GroupNumber == "18_10_30"] <- 18
data$GroupNumber[data$GroupNumber == "19_10_50"] <- 19
data$GroupNumber[data$GroupNumber == "20_10_50"] <- 20
data$GroupNumber[data$GroupNumber == "21_12_15"] <- 21
data$GroupNumber[data$GroupNumber == "22_12_15"] <- 22
data$GroupNumber[data$GroupNumber == "23_12_40"] <- 23
data$GroupNumber[data$GroupNumber == "24_12_40"] <- 24
data$GroupNumber[data$GroupNumber == "25_15_00"] <- 25
data$GroupNumber[data$GroupNumber == "26_15_00"] <- 26
data$GroupNumber[data$GroupNumber == "27_15_20"] <- 27
data$GroupNumber[data$GroupNumber == "28_15_20"] <- 28
data$GroupNumber[data$GroupNumber == "29_16_00"] <- 29
data$GroupNumber[data$GroupNumber == "30_16_00"] <- 30
data$GroupNumber[data$GroupNumber == "31_16_20"] <- 31
data$GroupNumber[data$GroupNumber == "32_16_20"] <- 32
data$GroupNumber[data$GroupNumber == "33_9_30"] <- 33
data$GroupNumber[data$GroupNumber == "34_09_30"] <- 34
data$GroupNumber[data$GroupNumber == "35_09_50"] <- 35
data$GroupNumber[data$GroupNumber == "36_9_50"] <- 36
data$GroupNumber[data$GroupNumber == "37_26_4"] <- 37
data$GroupNumber[data$GroupNumber == "38_26_4"] <- 38
data$GroupNumber[data$GroupNumber == "39_26_4"] <- 39
data$GroupNumber[data$GroupNumber == "40_26_4"] <- 40

#Cleaning subject IDs
data$SubjectID_left <- as.character(data$SubjectID_left)
data$SubjectID_right <- as.character(data$SubjectID_right)
data$SubjectID_left[data$SubjectID_left == "steph"] <- "stephanie"
data$SubjectID_right[data$SubjectID_right == "Emil"] <- "emil"
data$SubjectID_right[data$SubjectID_right == "Sebber"] <- "seb"
data$SubjectID_left[data$SubjectID_left == "signe"] <- "SigneR"
data$SubjectID_right[data$SubjectID_right == "karo"] <- "Karoline"
data$SubjectID_right[data$SubjectID_right == "tobias"] <- "Toby"
data$SubjectID_left[data$SubjectID_left == "Nina"] <- "nina"
data$SubjectID_right[data$SubjectID_right == "theasmom"] <- "Theasmom"
data$SubjectID_left[data$SubjectID_left == "emma"] <- "Emma"
data$SubjectID_right[data$SubjectID_right == "LasseKob"] <- "Lasse"
```

##Adding difficulty variable og dummy coding
```{r making variables for sensitivty, include = FALSE}
#Making unique subjects
data$unique_ID_right <- paste(data$GroupNumber, data$SubjectID_right, sep = "_")
data$unique_ID_left <- paste(data$GroupNumber, data$SubjectID_left, sep = "_")

#Making column, which expresses difficulty
data$dif_blue <- data$Prop_blue_image_2 - data$Prop_blue_image_1
data$dif_blue_abs <- abs(data$Prop_blue_image_2 - data$Prop_blue_image_1)

#Making a column, which expresses answer of participants, 0 = left picture, 1 = right picture
data$right_answer <- ifelse(data$Response_right > 0, 1, 0)
data$left_answer <- ifelse(data$Response_left > 0, 1, 0)

#Joining joint answer to one column
data$joint_answer <- data$Joint_right+ data$Joint_left

#Recoding joint answer to be 0 and 1's, 0 right, 1 left, NA = no leader
data$joint_answer[data$joint_answer == 0] <- NA #Replacing 0's with NA
data$joint_answer[data$joint_answer == -1] <- 0
```


##Adding variables: Agree, chosen leader and gender
```{r coding for leader/follower}

#create a column that sorts out all the agreed trials
data$chosen_leader <- ifelse(data$right_answer == data$left_answer, "Agree", 0) 

#Create variable, which determines the chosen leader
data$chosen_leader[data$chosen_leader == 0 & data$Joint_right == 0] <- "Left_lead"
data$chosen_leader[data$chosen_leader == 0 & data$Joint_left == 0] <- "Right_lead"

#create column that specifies the gender of the leader
data$Leader_gender <- 0
data$Leader_gender <- ifelse(data$chosen_leader == "Left_lead", as.character(data$Gender_left), as.character(data$Gender_right))
data$Leader_gender[data$chosen_leader == "Agree"] <- NA

#create column that specifies the gender of the follower
data$Follower_gender <- 0
data$Follower_gender <- ifelse(data$chosen_leader == "Left_lead", as.character(data$Gender_right), as.character(data$Gender_left))
data$Follower_gender[data$chosen_leader == "Agree"] <- NA

```

##Adding variable: Stick/surrender
```{r Did the leader stick?}
#leader stubbornness
data$Stubborn_leader <- 0 #Creating column of 0's

data$Stubborn_leader[data$chosen_leader == "Right_lead" & data$joint_answer == data$right_answer] <- "stick" #Inserting cases were leader stick for right leader
data$Stubborn_leader[data$chosen_leader == "Right_lead" & data$joint_answer != data$right_answer] <- "surrender" #Inserting cases were leader surrender for right leader

data$Stubborn_leader[data$chosen_leader == "Left_lead" & data$joint_answer == data$left_answer] <- "stick" #Inserting cases were leader stick for left leader
data$Stubborn_leader[data$chosen_leader == "Left_lead" & data$joint_answer != data$left_answer] <- "surrender" #Inserting cases were leader surreder for left leader

data$Stubborn_leader[data$chosen_leader == "Agree"] <- NA #Removing cases were they agree

```

#Sensitivity scores, partial pooling
We need one column containing answer from both left and right in order to allow pooling between all participants

##Long format
```{r making long format, include = FALSE}
#Subsetting the left data
left <- subset(data, select = c(GroupNumber, unique_ID_left, dif_blue, left_answer, joint_answer, Correct_left, Correct_joint, dif_blue_abs))

#Changing names
names(left) <- c("GroupNumber", "unique", "dif_blue", "answer", "joint_answer", "Correct", "Correct_joint", "dif_blue_abs")

#Subsetting right data
right <- subset(data, select = c(GroupNumber, unique_ID_right, dif_blue, right_answer, joint_answer, Correct_left, Correct_joint, dif_blue_abs))

#Chainging names
names(right) <- c("GroupNumber", "unique", "dif_blue", "answer", "joint_answer", "Correct", "Correct_joint", "dif_blue_abs")

#Removing half the joint data to inform the model, there is only one. 
right$Correct_joint <- NA
right$joint_answer <- NA

#Joining the dataframes
ldata <- rbind(left, right)

#Setting NA in correct answers
ldata$Correct_joint[is.na(ldata$joint_answer)] <- NA

```

##Modelling sensitivity scores (using answer)
```{r creating model with partial pooling, individual}

#Getting priors
get_prior(answer ~ dif_blue + (1+ dif_blue|unique), family = "bernoulli", data = ldata)

#Defining priors
prior =  c(
  prior(normal(0,0.125), class = "b", coef = "dif_blue"),
  prior(normal(0,0.17), class = "Intercept"),
  prior(normal(0,0.125), class = "sd", coef = "dif_blue", group = "unique"),
  prior(normal(0,0.17), class = "sd", coef = "Intercept", group = "unique")
)

  
#Defining paths for plots
trans_path = file.path("~/gender_bias_in_decision_making/Gender_bias_study_1/plots/transition/trans_plot.jpeg")
pp_path = file.path("~/gender_bias_in_decision_making/Gender_bias_study_1/plots/pp_check/pp_plot.jpeg")

marginal_path = file.path("~/gender_bias_in_decision_making/Gender_bias_study_1/plots/marginal/marginal_plot.jpeg")


#Prior predictive check
prior_check <- brm( answer ~ dif_blue + (dif_blue|unique), prior = prior,
           data = ldata, sample_prior = "only",iter = 4000, family = "bernoulli")


#Making the model
m_sensitivity <- brm(
  answer ~ dif_blue + (1+dif_blue|unique),
  data = ldata,
  prior = prior,
  family = "bernoulli", #As we had a binary outcome, we set this to "bernoulli"
  seed = 123 # Adding a seed makes results reproducible.
) 


#Marginal effects plot: Plotted and saved
jpeg(file=marginal_path)
print(marginal_effects(m_sensitivity))
dev.off()
  
#transition plot: Plotted and saved
jpeg(file=trans_path)
print(plot(m_sensitivity))
dev.off()

#pp_check plot: Plotted and saved
jpeg(file=pp_path)
print(pp_check(prior_check, nsamples = 100))
dev.off()

```


##Saving estimates from sensitivity
```{r}
#Saving the estimates

#Saving random effect for individual 
ranef <- as.data.frame(ranef(m_sensitivity))[,1:2] #Intercept
ranef <- cbind(ranef, as.data.frame(ranef(m_sensitivity))[,5:6]) #Slope

#Adding fixed effects to random effect
fixef <- as.data.frame(fixef(m_sensitivity)) #Making data frame of fixed effects

sensitivity_scores <-data.frame(matrix(ncol = 0, nrow = 80))

sensitivity_scores$Slope_ranef_fixef_estimate <- ranef[, 3] + fixef[1, 2] #Adding fixef of slope to ranef of slope


#Adding rownames
sensitivity_scores <- cbind(Row.Names = rownames(ranef), as.data.frame(sensitivity_scores))

write.csv(sensitivity_scores, file = "sensitivity_scores.csv")
```

#Making a wide format 
```{r creating wide format, include = FALSE, this does not work}

#Creating two empty columns in data for sensitivity scores
data$sensitivity_right <- NA
data$sensitivity_left <- NA

#Looping through sensitivity scores and matching them to the right player
t = 1
for (i in sensitivity_scores$Row.Names) {
  print(i)
  for (p in data$unique_ID_right) {
    if(i == p){
      data$sensitivity_right[data$unique_ID_right == p] = sensitivity_scores$Slope_ranef_fixef_estimate[t]
    } 
  }
  t = t+1
}


#Looping through sensitivity scores and matching them to the left player
t = 1
for (i in sensitivity_scores$Row.Names) {
  print(i)
  for (p in data$unique_ID_left) {
    if(i == p){
      data$sensitivity_left[data$unique_ID_left == p] = sensitivity_scores$Slope_ranef_fixef_estimate[t]
    } 
  }
  t = t+1
}

```


#Write CSV with sensitivity scores and clean data
```{r}
write.csv(sensitivity_scores, file = "data_wide_sensitivity.csv")
```

